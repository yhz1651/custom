# 风险检测API测试案例说明

本文档描述了风险检测API的三个测试案例，每个案例展示了不同的风险检测场景和算子组合。

## 案例概览

| 案例 | 场景 | 算子类型 | 逻辑组合 | 预期结果 |
|------|------|----------|----------|----------|
| 案例1 | 申报重量和价格双重异常 | diff_operator + ratio_operator | and_operator | 高风险 |
| 案例2 | 货物申报三维异常检测 | 三个ratio_operator | and3_operator | 高风险 |
| 案例3 | 冷链运输温度异常监控 | diff_operator + 两个cmp_operator | or3_operator | 中等风险 |

## 详细案例说明

### 案例1: 申报重量和价格双重异常

**场景描述**: 检测货物申报中的重量超限和价格异常情况

**输入特征**:
- 申报重量: 55kg
- 限重: 50kg  
- 申报价格: 100元
- 参考价格: 80元

**检测规则**:
1. `diff_operator`: 申报重量 - 限重 ≥ 0 (检查是否超重)
2. `ratio_operator`: 申报价格/参考价格 ≥ 1.2 (检查价格是否异常偏高)
3. `and_operator`: 两个条件都满足才触发风险

**计算过程**:
- 重量差值: 55 - 50 = 5 ≥ 0 → 满足条件 (1)
- 价格比值: 100/80 = 1.25 ≥ 1.2 → 满足条件 (1)  
- 逻辑与: 1 AND 1 = 1 → 触发风险

**风险类型**: 申报重量超限且价格异常的复合风险

### 案例2: 货物申报三维异常检测

**场景描述**: 检测货物申报中数量、体积、频次的三维异常模式

**输入特征**:
- 申报数量: 1000件
- 历史平均数量: 500件
- 申报体积: 2.5m³
- 标准体积: 1.8m³
- 申报频次: 15次/月
- 正常频次: 8次/月

**检测规则**:
1. `ratio_operator`: 申报数量/历史平均数量 ≥ 1.5
2. `ratio_operator`: 申报体积/标准体积 ≥ 1.3  
3. `ratio_operator`: 申报频次/正常频次 ≥ 1.5
4. `and3_operator`: 三个条件都满足才触发风险

**计算过程**:
- 数量比值: 1000/500 = 2.0 ≥ 1.5 → 满足条件 (1)
- 体积比值: 2.5/1.8 = 1.39 ≥ 1.3 → 满足条件 (1)
- 频次比值: 15/8 = 1.875 ≥ 1.5 → 满足条件 (1)
- 三元逻辑与: 1 AND 1 AND 1 = 1 → 触发风险

**风险类型**: 货物申报三维指标全面异常的高危风险

### 案例3: 冷链运输温度异常监控

**场景描述**: 检测冷链运输过程中的温度、湿度异常情况

**输入特征**:
- 当前温度: -15.5°C
- 标准温度: -18.0°C
- 温度变化率: 0.8°C/小时
- 安全变化率: 0.5°C/小时
- 湿度偏差: 12.0%
- 湿度阈值: 10.0%

**检测规则**:
1. `diff_operator`: 当前温度 - 标准温度 ≥ 2.0 (检查温度偏差)
2. `cmp_operator`: 温度变化率 ≥ 安全变化率 (检查变化率)
3. `cmp_operator`: 湿度偏差 ≥ 湿度阈值 (检查湿度)
4. `or3_operator`: 任一条件满足就触发风险

**计算过程**:
- 温度差值: -15.5 - (-18.0) = 2.5 ≥ 2.0 → 满足条件 (1)
- 变化率比较: 0.8 ≥ 0.5 → 满足条件 (1)
- 湿度比较: 12.0 ≥ 10.0 → 满足条件 (1)
- 三元逻辑或: 1 OR 1 OR 1 = 1 → 触发风险

**风险类型**: 冷链运输环境控制异常风险

## 算子说明

### 属性算子
- **diff_operator**: 计算两个值的差值并与阈值比较
- **ratio_operator**: 计算两个值的比值并与阈值比较  
- **cmp_operator**: 直接比较两个值的大小关系

### 逻辑算子
- **and_operator**: 二元逻辑与，要求所有条件都满足
- **and3_operator**: 三元逻辑与，要求所有三个条件都满足
- **or3_operator**: 三元逻辑或，任一条件满足即可

## 运行测试

### 方法1: 使用bash脚本运行所有测试
chmod +x run_tests.sh
./run_tests.sh

### 方法2: 单独运行Python测试脚本
python test_cases.py

### 方法3: 使用curl命令单独测试
# 案例1
```bash
curl -X POST http://localhost:8000/explain_risk \
  -H "Content-Type: application/json" \
  -d '{
    "risk_features": {
      "申报重量": 55, "限重": 50, "申报价格": 100, "参考价格": 80
    },
    "rules": [
      ["diff_operator", ["申报重量", "限重"], 0],
      ["ratio_operator", ["申报价格", "参考价格"], 1.2],
      ["and_operator", [], null]
    ]
  }'
```

# 案例2
```bash
curl -X POST http://localhost:8000/explain_risk \
  -H "Content-Type: application/json" \
  -d '{
    "risk_features": {
      "申报数量": 1000, "历史平均数量": 500, "申报体积": 2.5, 
      "标准体积": 1.8, "申报频次": 15, "正常频次": 8
    },
    "rules": [
      ["ratio_operator", ["申报数量", "历史平均数量"], 1.5],
      ["ratio_operator", ["申报体积", "标准体积"], 1.3],
      ["ratio_operator", ["申报频次", "正常频次"], 1.5],
      ["and3_operator", [], null]
    ]
  }'
```
# 案例3
```bash
curl -X POST http://localhost:8000/explain_risk \
  -H "Content-Type: application/json" \
  -d '{
    "risk_features": {
      "当前温度": -15.5, "标准温度": -18.0, "温度变化率": 0.8,
      "安全变化率": 0.5, "湿度偏差": 12.0, "湿度阈值": 10.0
    },
    "rules": [
      ["diff_operator", ["当前温度", "标准温度"], 2.0],
      ["cmp_operator", ["温度变化率", "安全变化率"], null],
      ["cmp_operator", ["湿度偏差", "湿度阈值"], null],
      ["or3_operator", [], null]
    ]
  }'
```
## 预期输出

每个测试案例都会返回包含以下信息的JSON响应：
- **multi_dimensional_structure**: 详细的计算步骤和中间结果
- **semantic_description**: 大模型生成的语义描述
- **summary**: 汇总信息，包括风险指标、风险等级等

## 注意事项

1. 确保服务已启动: `python app.py`
2. 确保大模型服务可访问: `http://100.100.20.144:9997/v1/chat/completions`
3. 所有特征值和阈值应为数值类型
4. 规则数组的最后一个元素必须是逻辑算子
